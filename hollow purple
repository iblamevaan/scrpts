local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local root = character:WaitForChild("HumanoidRootPart")

local canCast = true -- cooldown flag

-- Fire effect function
local function addFireEffect(part, color)
	local fire = Instance.new("Fire")
	fire.Color = color
	fire.SecondaryColor = color
	fire.Heat = 10
	fire.Size = part.Size.X * 2
	fire.Parent = part
end

-- Ball creation function
local function createBall(color, size, canCollide)
	local ball = Instance.new("Part")
	ball.Shape = Enum.PartType.Ball
	ball.Size = size
	ball.Anchored = false
	ball.CanCollide = canCollide
	ball.Material = Enum.Material.Neon
	ball.Color = color
	ball.Name = "PurpleBall"
	ball.Parent = workspace
	addFireEffect(ball, color)

	local antiGravity = Instance.new("BodyForce")
	antiGravity.Force = Vector3.new(0, ball:GetMass() * workspace.Gravity, 0)
	antiGravity.Parent = ball

	return ball
end

-- Side block function
local function createSideBlock(position)
	local block = Instance.new("Part")
	block.Size = Vector3.new(12, 12, 12)
	block.Anchored = true
	block.CanCollide = false
	block.Material = Enum.Material.SmoothPlastic

	local rayOrigin = position
	local rayDirection = Vector3.new(0, -100, 0)
	local raycastParams = RaycastParams.new()
	raycastParams.FilterDescendantsInstances = {}
	raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

	local result = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
	if result and result.Instance and result.Instance:IsA("BasePart") then
		block.Color = result.Instance.Color
	else
		block.Color = Color3.fromRGB(200, 200, 200)
	end

	block.CFrame = CFrame.new(position) * CFrame.Angles(
		math.rad(math.random(0, 360)),
		math.rad(math.random(0, 360)),
		math.rad(math.random(0, 360))
	)

	block.Parent = workspace

	local goal = { Position = block.Position - Vector3.new(0, 7, 0) }
	local tween = TweenService:Create(block, TweenInfo.new(0.8, Enum.EasingStyle.Sine), goal)
	tween:Play()
	tween.Completed:Connect(function()
		block:Destroy()
	end)
end

-- Function to run the effect
local function triggerPurpleBall()
	if not canCast then return end
	canCast = false

	-- Reset cooldown after 1 second
	task.delay(1, function()
		canCast = true
	end)

	-- Red and blue balls
	local redBall = createBall(Color3.fromRGB(255, 0, 0), Vector3.new(6, 6, 6), true)
	local blueBall = createBall(Color3.fromRGB(0, 0, 255), Vector3.new(6, 6, 6), true)

	-- Follow player
	local followConnection = RunService.RenderStepped:Connect(function()
		if root and root.Parent then
			local back = -root.CFrame.LookVector * 5
			local left = -root.CFrame.RightVector * 10
			local right = root.CFrame.RightVector * 10
			redBall.Position = root.Position + back + left + Vector3.new(0, 3, 0) -- slightly above ground
			blueBall.Position = root.Position + back + right + Vector3.new(0, 3, 0)
		end
	end)

	-- Wait then merge
	task.wait(3)
	followConnection:Disconnect()

	local mergePos = root.Position + root.CFrame.LookVector * 25 + Vector3.new(0, 5, 0) -- spawn slightly above ground
	local tweenInfo = TweenInfo.new(1, Enum.EasingStyle.Sine)
	TweenService:Create(redBall, tweenInfo, {Position = mergePos}):Play()
	TweenService:Create(blueBall, tweenInfo, {Position = mergePos}):Play()
	task.wait(1)
	redBall:Destroy()
	blueBall:Destroy()

	-- Purple ball
	local purpleBall = createBall(Color3.fromRGB(228, 0, 228), Vector3.new(48, 48, 48), false)
	purpleBall.Position = mergePos

	-- Play audio immediately
	local purpleSound = Instance.new("Sound")
	purpleSound.SoundId = "rbxassetid://97152929398060"
	purpleSound.Volume = 5
	purpleSound.Parent = purpleBall
	purpleSound:Play()

	-- Blackhole attraction
	local blockSpawnerConnection
	local pullConnection

	local function attractNearbyParts()
		if not purpleBall or not purpleBall.Parent then
			if pullConnection then
				pullConnection:Disconnect()
				pullConnection = nil
			end
			return
		end

		local maxDistance = 150
		local pullRadius = 100
		local pullForce = 400000

		local region = Region3.new(
			purpleBall.Position - Vector3.new(maxDistance, maxDistance, maxDistance),
			purpleBall.Position + Vector3.new(maxDistance, maxDistance, maxDistance)
		)

		local ignoreList = {character, purpleBall}
		for _, plr in pairs(Players:GetPlayers()) do
			if plr.Character then
				table.insert(ignoreList, plr.Character)
			end
		end

		local parts = workspace:FindPartsInRegion3WithIgnoreList(region, ignoreList, math.huge)

		for _, part in ipairs(parts) do
			if part:IsA("BasePart") and not part.Anchored then
				local distance = (part.Position - purpleBall.Position).Magnitude
				local velocityControl = part:FindFirstChild("BlackholePull")

				if distance <= pullRadius then
					if not velocityControl then
						velocityControl = Instance.new("BodyVelocity")
						velocityControl.Name = "BlackholePull"
						velocityControl.MaxForce = Vector3.new(pullForce, pullForce, pullForce)
						velocityControl.P = 4000000
						velocityControl.Parent = part
					end
					local direction = (purpleBall.Position - part.Position).Unit
					velocityControl.Velocity = direction * 300
				else
					if velocityControl then
						velocityControl:Destroy()
					end
				end
			end
		end
	end

	-- Purple movement + effects
	task.delay(1, function()
		local destination = purpleBall.Position + root.CFrame.LookVector * 500
		local moveTween = TweenService:Create(purpleBall, TweenInfo.new(8, Enum.EasingStyle.Linear), {Position = destination})
		moveTween:Play()

		blockSpawnerConnection = RunService.RenderStepped:Connect(function()
			if purpleBall and purpleBall.Parent then
				local pos = purpleBall.Position
				local rightVec = purpleBall.CFrame.RightVector
				createSideBlock(pos - rightVec * 8)
				createSideBlock(pos + rightVec * 8)
			end
		end)

		pullConnection = RunService.Heartbeat:Connect(attractNearbyParts)
	end)

	-- Cleanup
	task.delay(7, function()
		if purpleBall and purpleBall.Parent then
			purpleBall:Destroy()
		end
		if blockSpawnerConnection then
			blockSpawnerConnection:Disconnect()
		end
		if pullConnection then
			pullConnection:Disconnect()
		end
		if purpleSound and purpleSound.Parent then
			purpleSound:Stop()
			purpleSound:Destroy()
		end
	end)
end

-- Bind to C key
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.KeyCode == Enum.KeyCode.C then
		triggerPurpleBall()
	end
end)
